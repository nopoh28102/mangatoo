{% extends "base.html" %}

{% block title %}Publisher Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <span data-lang="en">Publisher Dashboard</span>
                    <span data-lang="ar">لوحة تحكم الناشر</span>
                </h1>
                <a href="{{ url_for('publisher_upload') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    <span data-lang="en">Upload New Manga</span>
                    <span data-lang="ar">رفع مانجا جديدة</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ user_manga|length }}</h4>
                            <p class="mb-0">
                                <span data-lang="en">Total Manga</span>
                                <span data-lang="ar">إجمالي المانجا</span>
                            </p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>
                                {% set total_chapters = namespace(value=0) %}
                                {% for manga in user_manga %}
                                    {% set total_chapters.value = total_chapters.value + manga.total_chapters %}
                                {% endfor %}
                                {{ total_chapters.value }}
                            </h4>
                            <p class="mb-0">
                                <span data-lang="en">Total Chapters</span>
                                <span data-lang="ar">إجمالي الفصول</span>
                            </p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>
                                {% set total_views = namespace(value=0) %}
                                {% for manga in user_manga %}
                                    {% set total_views.value = total_views.value + manga.views %}
                                {% endfor %}
                                {{ "{:,}".format(total_views.value) }}
                            </h4>
                            <p class="mb-0">
                                <span data-lang="en">Total Views</span>
                                <span data-lang="ar">إجمالي المشاهدات</span>
                            </p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>
                                {% set total_rating = namespace(value=0.0, count=0) %}
                                {% for manga in user_manga %}
                                    {% if manga.average_rating > 0 %}
                                        {% set total_rating.value = total_rating.value + manga.average_rating %}
                                        {% set total_rating.count = total_rating.count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ "%.1f"|format(total_rating.value / total_rating.count if total_rating.count > 0 else 0) }}
                            </h4>
                            <p class="mb-0">
                                <span data-lang="en">Avg Rating</span>
                                <span data-lang="ar">متوسط التقييم</span>
                            </p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-star fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Your Manga -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>
                        <span data-lang="en">Your Manga</span>
                        <span data-lang="ar">مانجا خاصة بك</span>
                    </h3>
                </div>
                <div class="card-body">
                    {% if user_manga %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th data-lang="en">Title</th>
                                        <th data-lang="ar" style="display: none;">العنوان</th>
                                        <th data-lang="en">Chapters</th>
                                        <th data-lang="ar" style="display: none;">الفصول</th>
                                        <th data-lang="en">Views</th>
                                        <th data-lang="ar" style="display: none;">المشاهدات</th>
                                        <th data-lang="en">Rating</th>
                                        <th data-lang="ar" style="display: none;">التقييم</th>
                                        <th data-lang="en">Status</th>
                                        <th data-lang="ar" style="display: none;">الحالة</th>
                                        <th data-lang="en">Actions</th>
                                        <th data-lang="ar" style="display: none;">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for manga in user_manga %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if manga.cover_image %}
                                                    <img src="{{ url_for('static', filename=manga.cover_image.replace('static/', '')) }}" 
                                                         alt="{{ manga.title }}" class="me-2" style="width: 40px; height: 60px; object-fit: cover;">
                                                {% endif %}
                                                <div>
                                                    <strong>{{ manga.title }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ manga.author }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ manga.total_chapters }}</td>
                                        <td>{{ "{:,}".format(manga.views) }}</td>
                                        <td>
                                            <span class="badge bg-warning">
                                                {{ "%.1f"|format(manga.average_rating) }} ★
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if manga.status == 'ongoing' %}success{% elif manga.status == 'completed' %}primary{% else %}secondary{% endif %}">
                                                {{ manga.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {%% if manga.slug %%}
                                                <a href="{{ url_for('manga_detail', slug=manga.slug) }}" class="btn btn-outline-primary">
                                                {%% else %%}
                                                <a href="{{ url_for('manga_detail_by_id', manga_id=manga.id) }}" class="btn btn-outline-primary">
                                                {%% endif %%}
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('admin_upload') }}" class="btn btn-outline-success">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-book fa-5x text-muted mb-3"></i>
                            <h4 class="text-muted">
                                <span data-lang="en">No manga uploaded yet</span>
                                <span data-lang="ar">لم يتم رفع أي مانجا بعد</span>
                            </h4>
                            <p class="text-muted">
                                <span data-lang="en">Start by uploading your first manga to share with readers worldwide!</span>
                                <span data-lang="ar">ابدأ برفع مانجا الأولى لمشاركتها مع القراء حول العالم!</span>
                            </p>
                            <a href="{{ url_for('publisher_upload') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                <span data-lang="en">Upload First Manga</span>
                                <span data-lang="ar">رفع أول مانجا</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}