{% extends "base.html" %}

{% block title %}دفع عبر Mastercard - المنصة{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark text-center">
                    <h4 class="mb-0">
                        <i class="fab fa-cc-mastercard me-2"></i>
                        دفع آمن بماستركارد
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Payment Summary -->
                    <div class="alert alert-info">
                        <h5 class="alert-heading">ملخص الطلب</h5>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>{{ plan.name_ar or plan.name }}</span>
                            <strong>${{ payment.amount }}</strong>
                        </div>
                    </div>

                    <!-- Mastercard Form -->
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-lock me-2"></i>
                                بيانات بطاقة ماستركارد
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="mastercardForm">
                                <div class="mb-3">
                                    <label for="cardNumber" class="form-label">رقم بطاقة ماستركارد</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fab fa-cc-mastercard text-warning"></i>
                                        </span>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="5*** **** **** ****" maxlength="19">
                                    </div>
                                    <div class="form-text">ادخل رقم بطاقة ماستركارد الخاصة بك</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="expiryDate" class="form-label">تاريخ الانتهاء</label>
                                        <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">رمز الأمان (CVC)</label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="3">
                                        <div class="form-text">الرقم المكون من 3 أرقام خلف البطاقة</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="cardholderName" class="form-label">اسم حامل البطاقة</label>
                                    <input type="text" class="form-control" id="cardholderName" placeholder="الاسم كما هو مكتوب على البطاقة">
                                </div>

                                <!-- Mastercard Features -->
                                <div class="alert alert-warning">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">
                                                <i class="fas fa-shield-alt me-2"></i>
                                                حماية ماستركارد SecureCode
                                            </h6>
                                            <small>حماية متقدمة للمعاملات الإلكترونية</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <i class="fab fa-cc-mastercard fa-3x text-warning"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Billing Information -->
                                <div class="border-top pt-3 mt-3">
                                    <h6 class="mb-3">معلومات الفوترة</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="email" class="form-label">البريد الإلكتروني</label>
                                            <input type="email" class="form-control" id="email" value="{{ current_user.email }}" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="phone" class="form-label">رقم الهاتف</label>
                                            <input type="tel" class="form-control" id="phone" placeholder="+966xxxxxxxxx">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="country" class="form-label">الدولة</label>
                                            <select class="form-select" id="country">
                                                <option value="SA">السعودية</option>
                                                <option value="AE">الإمارات</option>
                                                <option value="US">الولايات المتحدة</option>
                                                <option value="GB">المملكة المتحدة</option>
                                                <option value="EG">مصر</option>
                                                <option value="CA">كندا</option>
                                                <option value="AU">أستراليا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="postalCode" class="form-label">الرمز البريدي</label>
                                            <input type="text" class="form-control" id="postalCode" placeholder="12345">
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Button -->
                                <div class="d-grid mt-4">
                                    <button type="button" class="btn btn-warning btn-lg text-dark" onclick="processMastercardPayment()">
                                        <i class="fas fa-lock me-2"></i>
                                        ادفع ${{ payment.amount }} بـ Mastercard
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Mastercard Benefits -->
                    <div class="card border-success mt-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-star me-2"></i>
                                مميزات ماستركارد
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            حماية عالمية من الاحتيال
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            مقبولة في أكثر من 210 دولة
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            خدمة عملاء 24/7
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            دفع لا تلامسي
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            حماية المشتري
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            برامج مكافآت حصرية
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Info -->
                    <div class="alert alert-light mt-4">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                <h6>SecureCode</h6>
                                <small class="text-muted">حماية إضافية لتأكيد الهوية</small>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-eye-slash fa-2x text-primary mb-2"></i>
                                <h6>Zero Liability</h6>
                                <small class="text-muted">حماية من المعاملات غير المصرح بها</small>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-lock fa-2x text-warning mb-2"></i>
                                <h6>تشفير SSL</h6>
                                <small class="text-muted">تأمين البيانات أثناء النقل</small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('premium_plans') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            العودة للباقات
                        </a>
                        <div class="text-muted small">
                            <i class="fas fa-lock me-1"></i>
                            محمي بـ Mastercard SecureCode
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function processMastercardPayment() {
    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;
    const cardholderName = document.getElementById('cardholderName').value;
    const phone = document.getElementById('phone').value;
    const postalCode = document.getElementById('postalCode').value;
    
    // Validate Mastercard number (starts with 5 or between 2221-2720)
    const cleanNumber = cardNumber.replace(/\s/g, '');
    const isValidMastercard = cleanNumber.startsWith('5') || 
                             (parseInt(cleanNumber.substring(0, 4)) >= 2221 && 
                              parseInt(cleanNumber.substring(0, 4)) <= 2720);
    
    if (!isValidMastercard) {
        alert('رقم البطاقة المدخل ليس بطاقة ماستركارد صحيحة');
        return;
    }
    
    if (!cardNumber || !expiryDate || !cvv || !cardholderName || !phone) {
        alert('يرجى ملء جميع البيانات المطلوبة');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري المعالجة...';
    
    // Simulate SecureCode verification
    setTimeout(function() {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>تأكيد SecureCode...';
        
        setTimeout(function() {
            const verifySecureCode = confirm('سيتم إرسال كود تأكيد لهاتفك المسجل لدى البنك. هل تريد المتابعة؟');
            
            if (verifySecureCode) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>تأكيد الدفع...';
                
                setTimeout(function() {
                    alert('تم الدفع بنجاح عبر Mastercard!');
                    window.location.href = "{{ url_for('payment_success', payment_id=payment.id) }}";
                }, 2500);
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }, 2000);
    }, 1500);
}

// Format and validate Mastercard number
document.getElementById('cardNumber').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
    
    // Mastercard validation (starts with 5 or 2221-2720)
    if (value.length >= 4) {
        const isValidMastercard = value.startsWith('5') || 
                                 (parseInt(value.substring(0, 4)) >= 2221 && 
                                  parseInt(value.substring(0, 4)) <= 2720);
        
        if (!isValidMastercard) {
            e.target.setCustomValidity('رقم بطاقة ماستركارد غير صحيح');
        } else {
            e.target.setCustomValidity('');
        }
    }
    
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
});

// Format expiry date input
document.getElementById('expiryDate').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
});

// Format CVV input
document.getElementById('cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

// Format phone number
document.getElementById('phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.startsWith('966')) {
        value = '+' + value;
    } else if (value.startsWith('0')) {
        value = '+966' + value.substring(1);
    } else if (!value.startsWith('+')) {
        value = '+966' + value;
    }
    e.target.value = value;
});

// Format postal code
document.getElementById('postalCode').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9A-Za-z\s-]/g, '');
});
</script>
{% endblock %}