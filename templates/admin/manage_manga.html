{% extends "admin/base.html" %}

{% block title %}Manga Management - إدارة المانجا{% endblock %}

{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <span data-lang="en">Manga Management</span>
            <span data-lang="ar">إدارة المانجا</span>
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('admin_upload') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                <span data-lang="en">Add New Manga</span>
                <span data-lang="ar">إضافة مانجا جديدة</span>
            </a>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="fas fa-download me-2"></i>
                <span data-lang="en">Import</span>
                <span data-lang="ar">استيراد</span>
            </button>
            <button type="button" class="btn btn-success" onclick="exportManga()">
                <i class="fas fa-upload me-2"></i>
                <span data-lang="en">Export</span>
                <span data-lang="ar">تصدير</span>
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Total Manga</span>
                                <span data-lang="ar">إجمالي المانجا</span>
                            </h6>
                            <h3>{{ total_manga or 0 }}</h3>
                        </div>
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Published</span>
                                <span data-lang="ar">منشور</span>
                            </h6>
                            <h3>{{ published_manga or 0 }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Draft</span>
                                <span data-lang="ar">مسودة</span>
                            </h6>
                            <h3>{{ draft_manga or 0 }}</h3>
                        </div>
                        <i class="fas fa-edit fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Featured</span>
                                <span data-lang="ar">مميز</span>
                            </h6>
                            <h3>{{ featured_manga or 0 }}</h3>
                        </div>
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search" 
                           placeholder-en="Search manga..." 
                           placeholder-ar="البحث في المانجا..."
                           value="{{ search }}">
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="status">
                        <option value="">
                            <span data-lang="en">All Status</span>
                            <span data-lang="ar">جميع الحالات</span>
                        </option>
                        <option value="published" {{ 'selected' if request.args.get('status') == 'published' }}>
                            <span data-lang="en">Published</span>
                            <span data-lang="ar">منشور</span>
                        </option>
                        <option value="draft" {{ 'selected' if request.args.get('status') == 'draft' }}>
                            <span data-lang="en">Draft</span>
                            <span data-lang="ar">مسودة</span>
                        </option>
                        <option value="featured" {{ 'selected' if request.args.get('status') == 'featured' }}>
                            <span data-lang="en">Featured</span>
                            <span data-lang="ar">مميز</span>
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="category">
                        <option value="">
                            <span data-lang="en">All Categories</span>
                            <span data-lang="ar">جميع التصنيفات</span>
                        </option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {{ 'selected' if request.args.get('category') == category.id|string }}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="sort">
                        <option value="newest" {{ 'selected' if request.args.get('sort') == 'newest' }}>
                            <span data-lang="en">Newest First</span>
                            <span data-lang="ar">الأحدث أولاً</span>
                        </option>
                        <option value="oldest" {{ 'selected' if request.args.get('sort') == 'oldest' }}>
                            <span data-lang="en">Oldest First</span>
                            <span data-lang="ar">الأقدم أولاً</span>
                        </option>
                        <option value="alphabetical" {{ 'selected' if request.args.get('sort') == 'alphabetical' }}>
                            <span data-lang="en">A-Z</span>
                            <span data-lang="ar">أبجدي</span>
                        </option>
                        <option value="popular" {{ 'selected' if request.args.get('sort') == 'popular' }}>
                            <span data-lang="en">Most Popular</span>
                            <span data-lang="ar">الأكثر شعبية</span>
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>
                        <span data-lang="en">Filter</span>
                        <span data-lang="ar">فلترة</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manga Table -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5>
                    <span data-lang="en">Manga List</span>
                    <span data-lang="ar">قائمة المانجا</span>
                    {% if manga_list %}
                        <span class="badge bg-secondary ms-2">{{ manga_list.total }}</span>
                    {% endif %}
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <!-- Bulk Actions -->
                    <div class="btn-group btn-group-sm me-2" id="bulkActions" style="display: none;">
                        <button class="btn btn-warning" onclick="deleteSelected()" title="حذف المحدد">
                            <i class="fas fa-trash-alt me-1"></i>
                            <span data-lang="en">Delete Selected</span>
                            <span data-lang="ar">حذف المحدد</span>
                        </button>
                        <button class="btn btn-danger" onclick="deleteAll()" title="حذف الكل">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <span data-lang="en">Delete All</span>
                            <span data-lang="ar">حذف الكل</span>
                        </button>
                    </div>
                    
                    <!-- View Toggle -->
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" onclick="switchView('table')">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="switchView('grid')">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if manga_list and manga_list.items %}
            <!-- Table View -->
            <div id="table-view">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>
                                    <span data-lang="en">Manga</span>
                                    <span data-lang="ar">المانجا</span>
                                </th>
                                <th>
                                    <span data-lang="en">Author</span>
                                    <span data-lang="ar">المؤلف</span>
                                </th>
                                <th>
                                    <span data-lang="en">Category</span>
                                    <span data-lang="ar">التصنيف</span>
                                </th>
                                <th>
                                    <span data-lang="en">Chapters</span>
                                    <span data-lang="ar">الفصول</span>
                                </th>
                                <th>
                                    <span data-lang="en">Status</span>
                                    <span data-lang="ar">الحالة</span>
                                </th>
                                <th>
                                    <span data-lang="en">Stats</span>
                                    <span data-lang="ar">الإحصائيات</span>
                                </th>
                                <th>
                                    <span data-lang="en">Actions</span>
                                    <span data-lang="ar">الإجراءات</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for manga in manga_list.items %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input manga-checkbox" value="{{ manga.id }}">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ url_for('static', filename=manga.cover_image.replace('static/', '') if manga.cover_image else 'img/no-cover.png') }}" 
                                             class="rounded me-3" width="50" height="70" alt="{{ manga.title }}"
                                             style="object-fit: cover;">
                                        <div>
                                            <h6 class="mb-1">{{ manga.title }}</h6>
                                            {% if manga.alternative_title %}
                                                <small class="text-muted">{{ manga.alternative_title }}</small>
                                            {% endif %}
                                            <div class="mt-1">
                                                {% if manga.is_featured %}
                                                    <span class="badge bg-warning">
                                                        <span data-lang="en">Featured</span>
                                                        <span data-lang="ar">مميز</span>
                                                    </span>
                                                {% endif %}
                                                {% if manga.is_premium %}
                                                    <span class="badge bg-success">
                                                        <span data-lang="en">Premium</span>
                                                        <span data-lang="ar">مدفوع</span>
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ manga.author }}</strong>
                                        {% if manga.artist and manga.artist != manga.author %}
                                            <br><small class="text-muted">
                                                <span data-lang="en">Art:</span>
                                                <span data-lang="ar">الرسم:</span>
                                                {{ manga.artist }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if manga.categories %}
                                        {% for category in manga.categories %}
                                            <span class="badge bg-info me-1">{{ category.name }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-center">
                                        <strong>{{ manga.chapters.count() }}</strong>
                                        <br><small class="text-muted">
                                            <span data-lang="en">chapters</span>
                                            <span data-lang="ar">فصل</span>
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    {% if manga.status == 'published' %}
                                        <span class="badge bg-success">
                                            <span data-lang="en">Published</span>
                                            <span data-lang="ar">منشور</span>
                                        </span>
                                    {% elif manga.status == 'draft' %}
                                        <span class="badge bg-warning">
                                            <span data-lang="en">Draft</span>
                                            <span data-lang="ar">مسودة</span>
                                        </span>
                                    {% elif manga.status == 'archived' %}
                                        <span class="badge bg-secondary">
                                            <span data-lang="en">Archived</span>
                                            <span data-lang="ar">مؤرشف</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="d-flex mb-1">
                                            <i class="fas fa-eye text-primary me-1"></i>
                                            <span>{{ manga.views or 0 }}</span>
                                        </div>
                                        <div class="d-flex mb-1">
                                            <i class="fas fa-star text-warning me-1"></i>
                                            <span>{{ manga.rating or 0 }}</span>
                                        </div>
                                        <div class="d-flex">
                                            <i class="fas fa-bookmark text-info me-1"></i>
                                            <span>{{ manga.bookmarks_count or 0 }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if manga.slug %}
                                        <a href="{{ url_for('manga_detail', slug=manga.slug) }}" 
                                        {% else %}
                                        <a href="{{ url_for('manga_detail_by_id', manga_id=manga.id) }}" 
                                        {% endif %}
                                           class="btn btn-outline-primary" target="_blank" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('admin_edit_manga', manga_id=manga.id) }}" 
                                           class="btn btn-outline-secondary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('admin_add_chapter', manga_id=manga.id) }}" 
                                           class="btn btn-outline-success" title="Add Chapter">
                                            <i class="fas fa-plus"></i>
                                        </a>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                                    data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <button class="dropdown-item" onclick="toggleFeatured({{ manga.id }})">
                                                        <i class="fas fa-star me-2"></i>
                                                        {% if manga.is_featured %}
                                                            <span data-lang="en">Remove Featured</span>
                                                            <span data-lang="ar">إزالة الإبراز</span>
                                                        {% else %}
                                                            <span data-lang="en">Make Featured</span>
                                                            <span data-lang="ar">جعل مميز</span>
                                                        {% endif %}
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item" onclick="togglePremium({{ manga.id }})">
                                                        <i class="fas fa-crown me-2"></i>
                                                        {% if manga.is_premium %}
                                                            <span data-lang="en">Make Free</span>
                                                            <span data-lang="ar">جعل مجاني</span>
                                                        {% else %}
                                                            <span data-lang="en">Make Premium</span>
                                                            <span data-lang="ar">جعل مدفوع</span>
                                                        {% endif %}
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item" onclick="duplicateManga({{ manga.id }})">
                                                        <i class="fas fa-copy me-2"></i>
                                                        <span data-lang="en">Duplicate</span>
                                                        <span data-lang="ar">تكرار</span>
                                                    </button>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <button class="dropdown-item text-danger" onclick="deleteManga({{ manga.id }})">
                                                        <i class="fas fa-trash me-2"></i>
                                                        <span data-lang="en">Delete</span>
                                                        <span data-lang="ar">حذف</span>
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Grid View -->
            <div id="grid-view" class="d-none">
                <div class="row p-3">
                    {% for manga in manga_list.items %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="{{ url_for('static', filename=manga.cover_image.replace('static/', '') if manga.cover_image else 'img/no-cover.png') }}" 
                                     class="card-img-top" style="height: 250px; object-fit: cover;" alt="{{ manga.title }}">
                                <div class="position-absolute top-0 start-0 m-2">
                                    {% if manga.is_featured %}
                                        <span class="badge bg-warning">Featured</span>
                                    {% endif %}
                                    {% if manga.is_premium %}
                                        <span class="badge bg-success">Premium</span>
                                    {% endif %}
                                </div>
                                <div class="position-absolute top-0 end-0 m-2">
                                    <input type="checkbox" class="form-check-input manga-checkbox" value="{{ manga.id }}">
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">{{ manga.title }}</h6>
                                <p class="card-text">
                                    <small class="text-muted">{{ manga.author }}</small>
                                    {% if manga.categories %}
                                        <br>
                                        {% for category in manga.categories %}
                                            <span class="badge bg-info me-1">{{ category.name }}</span>
                                        {% endfor %}
                                    {% endif %}
                                </p>
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>{{ manga.chapters.count() }} chapters</span>
                                    <span>{{ manga.views or 0 }} views</span>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100 btn-group-sm">
                                    {% if manga.slug %}
                                    <a href="{{ url_for('manga_detail', slug=manga.slug) }}" 
                                    {% else %}
                                    <a href="{{ url_for('manga_detail_by_id', manga_id=manga.id) }}" 
                                    {% endif %}
                                       class="btn btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('admin_edit_manga', manga_id=manga.id) }}" 
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('admin_add_chapter', manga_id=manga.id) }}" 
                                       class="btn btn-outline-success">
                                        <i class="fas fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Pagination -->
            {% if manga_list.pages > 1 %}
            <div class="card-footer">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        {% if manga_list.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_manage_manga', page=manga_list.prev_num, **request.args) }}">
                                <span data-lang="en">Previous</span>
                                <span data-lang="ar">السابق</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in manga_list.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != manga_list.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin_manage_manga', page=page_num, **request.args) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if manga_list.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_manage_manga', page=manga_list.next_num, **request.args) }}">
                                <span data-lang="en">Next</span>
                                <span data-lang="ar">التالي</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-book fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">
                    <span data-lang="en">No manga found</span>
                    <span data-lang="ar">لم يتم العثور على مانجا</span>
                </h5>
                <p class="text-muted">
                    <span data-lang="en">Start by uploading your first manga</span>
                    <span data-lang="ar">ابدأ برفع أول مانجا</span>
                </p>
                <a href="{{ url_for('admin_upload') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    <span data-lang="en">Upload First Manga</span>
                    <span data-lang="ar">رفع أول مانجا</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function switchView(viewType) {
    if (viewType === 'table') {
        document.getElementById('table-view').classList.remove('d-none');
        document.getElementById('grid-view').classList.add('d-none');
    } else {
        document.getElementById('table-view').classList.add('d-none');
        document.getElementById('grid-view').classList.remove('d-none');
    }
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function toggleFeatured(mangaId) {
    fetch(`/admin/manga/${mangaId}/toggle-featured`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating manga');
        }
    });
}

function togglePremium(mangaId) {
    fetch(`/admin/manga/${mangaId}/toggle-premium`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating manga');
        }
    });
}

function duplicateManga(mangaId) {
    if (confirm('Create a duplicate of this manga?')) {
        fetch(`/admin/manga/${mangaId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error duplicating manga');
            }
        });
    }
}

function deleteManga(mangaId) {
    if (confirm('هل أنت متأكد من حذف هذا المانجا؟ سيتم حذف جميع الفصول والصور المرتبطة به.')) {
        fetch(`/admin/delete_manga/${mangaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء الحذف');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء الحذف');
        });
    }
}

function toggleFeatured(mangaId) {
    fetch(`/admin/toggle_featured/${mangaId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('حدث خطأ أثناء التحديث');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء التحديث');
    });
}

function togglePremium(mangaId) {
    fetch(`/admin/toggle_premium/${mangaId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('حدث خطأ أثناء التحديث');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء التحديث');
    });
}

function exportManga() {
    window.location.href = '/admin/manga/export';
}

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.manga-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    updateBulkActions();
});

// Update bulk actions visibility
function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.manga-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkedBoxes.length > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

// Add event listeners to individual checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.manga-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
});

// Delete selected manga
function deleteSelected() {
    const checkedBoxes = document.querySelectorAll('.manga-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('الرجاء تحديد مانجا واحدة على الأقل للحذف');
        return;
    }
    
    const mangaIds = Array.from(checkedBoxes).map(cb => cb.value);
    const count = mangaIds.length;
    
    if (confirm(`هل أنت متأكد من حذف ${count} مانجا محددة؟ سيتم حذف جميع الفصول والصور المرتبطة بها.`)) {
        fetch('/admin/delete_selected_manga', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                manga_ids: mangaIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء الحذف: ' + (data.message || 'خطأ غير معروف'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء الحذف');
        });
    }
}

// Delete all manga
function deleteAll() {
    const totalManga = {{ manga_list.total if manga_list else 0 }};
    
    if (totalManga === 0) {
        alert('لا يوجد مانجا للحذف');
        return;
    }
    
    const confirmMessage = `⚠️ تحذير: هذا الإجراء سيحذف جميع المانجا (${totalManga} مانجا)!\n\nهل أنت متأكد من أنك تريد حذف كل شيء؟ هذا الإجراء لا يمكن التراجع عنه!`;
    
    if (confirm(confirmMessage)) {
        // Double confirmation for safety
        if (confirm('تأكيد أخير: هل أنت متأكد تماماً من حذف جميع المانجا؟')) {
            fetch('/admin/delete_all_manga', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`تم حذف ${data.deleted_count} مانجا بنجاح`);
                    location.reload();
                } else {
                    alert('حدث خطأ أثناء الحذف: ' + (data.message || 'خطأ غير معروف'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('حدث خطأ أثناء الحذف');
            });
        }
    }
}
</script>
{% endblock %}