{% extends "admin/base.html" %}

{% block title %}
<span data-lang="en">Chapter Management - Admin Panel</span>
<span data-lang="ar">إدارة الفصول - لوحة التحكم</span>
{% endblock %}

{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <span data-lang="en">Chapter Management</span>
            <span data-lang="ar">إدارة الفصول</span>
        </h2>
        <div class="btn-group">
            <a href="{{ url_for('admin_upload_new') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                <span data-lang="en">Add New Manga</span>
                <span data-lang="ar">إضافة مانجا جديدة</span>
            </a>
            <button type="button" class="btn btn-info" onclick="bulkReorder()">
                <i class="fas fa-sort me-2"></i>
                <span data-lang="en">Bulk Reorder</span>
                <span data-lang="ar">إعادة ترتيب جماعي</span>
            </button>
        </div>
    </div>

    <!-- Chapter Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Total Chapters</span>
                                <span data-lang="ar">إجمالي الفصول</span>
                            </h6>
                            <h3>{{ total_chapters or 0 }}</h3>
                        </div>
                        <i class="fas fa-book-open fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Published</span>
                                <span data-lang="ar">منشور</span>
                            </h6>
                            <h3>{{ published_chapters or 0 }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Draft</span>
                                <span data-lang="ar">مسودة</span>
                            </h6>
                            <h3>{{ draft_chapters or 0 }}</h3>
                        </div>
                        <i class="fas fa-edit fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>
                                <span data-lang="en">Premium Only</span>
                                <span data-lang="ar">مدفوع فقط</span>
                            </h6>
                            <h3>{{ premium_chapters or 0 }}</h3>
                        </div>
                        <i class="fas fa-crown fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search" 
                           placeholder-en="Search chapters..." 
                           placeholder-ar="البحث في الفصول..."
                           value="{{ search }}">
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="manga">
                        <option value="">
                            <span data-lang="en">All Manga</span>
                            <span data-lang="ar">جميع المانجا</span>
                        </option>
                        {% for manga in manga_list %}
                        <option value="{{ manga.id }}" {{ 'selected' if request.args.get('manga') == manga.id|string }}>
                            {{ manga.title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="status">
                        <option value="">
                            <span data-lang="en">All Status</span>
                            <span data-lang="ar">جميع الحالات</span>
                        </option>
                        <option value="published" {{ 'selected' if request.args.get('status') == 'published' }}>
                            <span data-lang="en">Published</span>
                            <span data-lang="ar">منشور</span>
                        </option>
                        <option value="draft" {{ 'selected' if request.args.get('status') == 'draft' }}>
                            <span data-lang="en">Draft</span>
                            <span data-lang="ar">مسودة</span>
                        </option>
                        <option value="premium" {{ 'selected' if request.args.get('status') == 'premium' }}>
                            <span data-lang="en">Premium</span>
                            <span data-lang="ar">مدفوع</span>
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="sort">
                        <option value="newest" {{ 'selected' if request.args.get('sort') == 'newest' }}>
                            <span data-lang="en">Newest First</span>
                            <span data-lang="ar">الأحدث أولاً</span>
                        </option>
                        <option value="oldest" {{ 'selected' if request.args.get('sort') == 'oldest' }}>
                            <span data-lang="en">Oldest First</span>
                            <span data-lang="ar">الأقدم أولاً</span>
                        </option>
                        <option value="chapter_asc" {{ 'selected' if request.args.get('sort') == 'chapter_asc' }}>
                            <span data-lang="en">Chapter Number ↑</span>
                            <span data-lang="ar">رقم الفصل ↑</span>
                        </option>
                        <option value="chapter_desc" {{ 'selected' if request.args.get('sort') == 'chapter_desc' }}>
                            <span data-lang="en">Chapter Number ↓</span>
                            <span data-lang="ar">رقم الفصل ↓</span>
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>
                        <span data-lang="en">Filter</span>
                        <span data-lang="ar">فلترة</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chapters Table -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5>
                    <span data-lang="en">Chapters List</span>
                    <span data-lang="ar">قائمة الفصول</span>
                    {% if chapters %}
                        <span class="badge bg-secondary ms-2">{{ chapters.total }}</span>
                    {% endif %}
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-success" onclick="bulkPublish()">
                        <i class="fas fa-check me-1"></i>
                        <span data-lang="en">Publish Selected</span>
                        <span data-lang="ar">نشر المحدد</span>
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="bulkDraft()">
                        <i class="fas fa-edit me-1"></i>
                        <span data-lang="en">Draft Selected</span>
                        <span data-lang="ar">مسودة المحدد</span>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="bulkDelete()">
                        <i class="fas fa-trash me-1"></i>
                        <span data-lang="en">Delete Selected</span>
                        <span data-lang="ar">حذف المحدد</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if chapters and chapters.items %}
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <input type="checkbox" class="form-check-input" id="selectAll">
                            </th>
                            <th>
                                <span data-lang="en">Chapter</span>
                                <span data-lang="ar">الفصل</span>
                            </th>
                            <th>
                                <span data-lang="en">Manga</span>
                                <span data-lang="ar">المانجا</span>
                            </th>
                            <th>
                                <span data-lang="en">Pages</span>
                                <span data-lang="ar">الصفحات</span>
                            </th>
                            <th>
                                <span data-lang="en">Status</span>
                                <span data-lang="ar">الحالة</span>
                            </th>
                            <th>
                                <span data-lang="en">Stats</span>
                                <span data-lang="ar">الإحصائيات</span>
                            </th>
                            <th>
                                <span data-lang="en">Date</span>
                                <span data-lang="ar">التاريخ</span>
                            </th>
                            <th>
                                <span data-lang="en">Actions</span>
                                <span data-lang="ar">الإجراءات</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="chapters-tbody" class="sortable">
                        {% for chapter in chapters.items %}
                        <tr data-chapter-id="{{ chapter.id }}">
                            <td>
                                <input type="checkbox" class="form-check-input chapter-checkbox" value="{{ chapter.id }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="drag-handle me-2" title="Drag to reorder">
                                        <i class="fas fa-grip-vertical text-muted"></i>
                                    </div>
                                    <div>
                                        <strong>
                                            <span data-lang="en">Chapter {{ chapter.chapter_number }}</span>
                                            <span data-lang="ar">الفصل {{ chapter.chapter_number }}</span>
                                        </strong>
                                        {% if chapter.title %}
                                            <br><span class="text-muted">{{ chapter.title }}</span>
                                        {% endif %}
                                        <div class="mt-1">
                                            {% if chapter.is_premium %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-crown me-1"></i>
                                                    <span data-lang="en">Premium</span>
                                                    <span data-lang="ar">مدفوع</span>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename=chapter.manga.cover_image.replace('static/', '') if chapter.manga.cover_image else 'img/no-cover.png') }}" 
                                         class="rounded me-2" width="30" height="40" alt="{{ chapter.manga.title }}">
                                    <div>
                                        {% if chapter.manga.slug %}
                                        <a href="{{ url_for('manga_detail', slug=chapter.manga.slug) }}" 
                                           class="text-decoration-none fw-bold" target="_blank">
                                        {% else %}
                                        <a href="{{ url_for('manga_detail_by_id', manga_id=chapter.manga.id) }}" 
                                           class="text-decoration-none fw-bold" target="_blank">
                                        {% endif %}
                                            {{ chapter.manga.title }}
                                        </a>
                                        <br><small class="text-muted">{{ chapter.manga.author }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="text-center">
                                    <strong>{{ chapter.page_images.count() }}</strong>
                                    <br><small class="text-muted">
                                        <span data-lang="en">pages</span>
                                        <span data-lang="ar">صفحة</span>
                                    </small>
                                </div>
                            </td>
                            <td>
                                {% if chapter.status == 'published' %}
                                    <span class="badge bg-success">
                                        <span data-lang="en">Published</span>
                                        <span data-lang="ar">منشور</span>
                                    </span>
                                {% elif chapter.status == 'draft' %}
                                    <span class="badge bg-warning">
                                        <span data-lang="en">Draft</span>
                                        <span data-lang="ar">مسودة</span>
                                    </span>
                                {% elif chapter.status == 'scheduled' %}
                                    <span class="badge bg-info">
                                        <span data-lang="en">Scheduled</span>
                                        <span data-lang="ar">مجدول</span>
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="d-flex mb-1">
                                        <i class="fas fa-eye text-primary me-1"></i>
                                        <span>{{ chapter.views or 0 }}</span>
                                    </div>
                                    <div class="d-flex mb-1">
                                        <i class="fas fa-comment text-info me-1"></i>
                                        <span>{{ chapter.comments_count or 0 }}</span>
                                    </div>
                                    <div class="d-flex">
                                        <i class="fas fa-heart text-danger me-1"></i>
                                        <span>{{ chapter.likes or 0 }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ chapter.created_at.strftime('%Y-%m-%d') }}</div>
                                <small class="text-muted">{{ chapter.created_at.strftime('%H:%M') }}</small>
                                {% if chapter.published_at %}
                                    <br><small class="text-success">
                                        <span data-lang="en">Published:</span>
                                        <span data-lang="ar">نُشر:</span>
                                        {{ chapter.published_at.strftime('%m/%d') }}
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if chapter.slug and chapter.manga.slug %}
                                    <a href="{{ url_for('read_chapter', manga_slug=chapter.manga.slug, chapter_slug=chapter.slug) }}"
                                    {% else %}
                                    <a href="{{ url_for('read_chapter_by_id', chapter_id=chapter.id) }}"
                                    {% endif %} 
                                       class="btn btn-outline-primary" target="_blank" title="Read">
                                        <i class="fas fa-book-open"></i>
                                    </a>
                                    <button class="btn btn-outline-secondary" 
                                            onclick="editChapter({{ chapter.id }})" 
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-{{ 'warning' if chapter.status == 'published' else 'success' }}" 
                                            onclick="toggleStatus({{ chapter.id }})" 
                                            title="{{ 'Unpublish' if chapter.status == 'published' else 'Publish' }}">
                                        {% if chapter.status == 'published' %}
                                            <i class="fas fa-eye-slash"></i>
                                        {% else %}
                                            <i class="fas fa-check"></i>
                                        {% endif %}
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle" 
                                                data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <button class="dropdown-item" onclick="togglePremium({{ chapter.id }})">
                                                    <i class="fas fa-crown me-2"></i>
                                                    {% if chapter.is_premium %}
                                                        <span data-lang="en">Make Free</span>
                                                        <span data-lang="ar">جعل مجاني</span>
                                                    {% else %}
                                                        <span data-lang="en">Make Premium</span>
                                                        <span data-lang="ar">جعل مدفوع</span>
                                                    {% endif %}
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" onclick="scheduleChapter({{ chapter.id }})">
                                                    <i class="fas fa-clock me-2"></i>
                                                    <span data-lang="en">Schedule</span>
                                                    <span data-lang="ar">جدولة</span>
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" onclick="duplicateChapter({{ chapter.id }})">
                                                    <i class="fas fa-copy me-2"></i>
                                                    <span data-lang="en">Duplicate</span>
                                                    <span data-lang="ar">تكرار</span>
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="deleteChapter({{ chapter.id }})">
                                                    <i class="fas fa-trash me-2"></i>
                                                    <span data-lang="en">Delete</span>
                                                    <span data-lang="ar">حذف</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if chapters.pages > 1 %}
            <div class="card-footer">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        {% if chapters.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_chapters', page=chapters.prev_num, **request.args) }}">
                                <span data-lang="en">Previous</span>
                                <span data-lang="ar">السابق</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in chapters.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != chapters.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin_chapters', page=page_num, **request.args) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if chapters.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_chapters', page=chapters.next_num, **request.args) }}">
                                <span data-lang="en">Next</span>
                                <span data-lang="ar">التالي</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">
                    <span data-lang="en">No chapters found</span>
                    <span data-lang="ar">لم يتم العثور على فصول</span>
                </h5>
                <p class="text-muted">
                    <span data-lang="en">Start by adding your first chapter</span>
                    <span data-lang="ar">ابدأ بإضافة أول فصل</span>
                </p>
                <a href="{{ url_for('admin_upload_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    <span data-lang="en">Add New Manga</span>
                    <span data-lang="ar">إضافة مانجا جديدة</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.chapter-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
});

function toggleStatus(chapterId) {
    fetch(`/admin/chapter/${chapterId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating chapter status');
        }
    });
}

function togglePremium(chapterId) {
    fetch(`/admin/chapter/${chapterId}/toggle-premium`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating chapter premium status');
        }
    });
}

function scheduleChapter(chapterId) {
    const publishDate = prompt('Enter publish date (YYYY-MM-DD HH:MM):');
    if (publishDate) {
        fetch(`/admin/chapter/${chapterId}/schedule`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({publish_date: publishDate})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Chapter scheduled successfully');
                location.reload();
            } else {
                alert('Error scheduling chapter: ' + data.error);
            }
        });
    }
}

function duplicateChapter(chapterId) {
    if (confirm('Create a duplicate of this chapter?')) {
        fetch(`/admin/chapter/${chapterId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error duplicating chapter');
            }
        });
    }
}

function deleteChapter(chapterId) {
    if (confirm('Are you sure you want to delete this chapter? This action cannot be undone.')) {
        fetch(`/admin/chapter/${chapterId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting chapter');
            }
        });
    }
}

function bulkPublish() {
    const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => cb.value);
    if (selectedChapters.length === 0) {
        alert('Please select chapters to publish');
        return;
    }
    
    if (confirm(`Publish ${selectedChapters.length} selected chapters?`)) {
        fetch('/admin/chapters/bulk-publish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({chapter_ids: selectedChapters})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error publishing chapters');
            }
        });
    }
}

function bulkDraft() {
    const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => cb.value);
    if (selectedChapters.length === 0) {
        alert('Please select chapters to move to draft');
        return;
    }
    
    if (confirm(`Move ${selectedChapters.length} selected chapters to draft?`)) {
        fetch('/admin/chapters/bulk-draft', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({chapter_ids: selectedChapters})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error moving chapters to draft');
            }
        });
    }
}

function bulkDelete() {
    const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => cb.value);
    if (selectedChapters.length === 0) {
        alert('Please select chapters to delete');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedChapters.length} selected chapters? This action cannot be undone.`)) {
        fetch('/admin/chapters/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({chapter_ids: selectedChapters})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting chapters');
            }
        });
    }
}

function bulkReorder() {
    alert('Bulk reorder functionality - drag chapters to reorder them');
}

// Chapter Management Functions
function editChapter(chapterId) {
    window.location.href = `/admin/edit_chapter/${chapterId}`;
}

function deleteChapter(chapterId) {
    if (confirm('هل أنت متأكد من حذف هذا الفصل؟ سيتم حذف جميع الصور المرتبطة به.')) {
        fetch(`/admin/delete_chapter/${chapterId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء الحذف');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء الحذف');
        });
    }
}

function toggleStatus(chapterId) {
    fetch(`/admin/toggle_chapter_status/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('حدث خطأ أثناء التحديث');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء التحديث');
    });
}

function togglePremium(chapterId) {
    fetch(`/admin/toggle_chapter_premium/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('حدث خطأ أثناء التحديث');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء التحديث');
    });
}

function scheduleChapter(chapterId) {
    const datetime = prompt('أدخل تاريخ ووقت النشر (YYYY-MM-DD HH:MM):');
    if (datetime) {
        fetch(`/admin/schedule_chapter/${chapterId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ datetime: datetime })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تم جدولة الفصل بنجاح');
                location.reload();
            } else {
                alert('حدث خطأ أثناء الجدولة');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء الجدولة');
        });
    }
}

function duplicateChapter(chapterId) {
    if (confirm('هل تريد تكرار هذا الفصل؟')) {
        fetch(`/admin/duplicate_chapter/${chapterId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تم تكرار الفصل بنجاح');
                location.reload();
            } else {
                alert('حدث خطأ أثناء التكرار');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء التكرار');
        });
    }
}

// Initialize sortable if SortableJS is loaded
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('chapters-tbody');
    if (tbody && typeof Sortable !== 'undefined') {
        new Sortable(tbody, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function(evt) {
                // Handle reordering
                const chapterIds = Array.from(tbody.children).map(row => row.dataset.chapterId);
                fetch('/admin/chapters/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({chapter_ids: chapterIds})
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Error reordering chapters');
                        location.reload();
                    }
                });
            }
        });
    }
});
</script>
{% endblock %}